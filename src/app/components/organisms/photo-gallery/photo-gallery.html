<!-- src/app/components/organisms/photo-gallery/photo-gallery.html -->
<section class="gallery-container">
  <!-- üå∏ Encabezado -->
  <header class="gallery-header">
    <div class="gallery-heading">
      <h1 class="gallery-title">Nuestros recuerdos</h1>
      <div class="header-actions">
        <p class="gallery-subtitle">
          @if (isSelectionMode) {
            Selecciona multiples recuerdos para descargarlos o eliminarlos.
          } @else {
            Elige un momento para revivirlo. Las fotos m√°s recientes aparecen primero.
          }
        </p>

        <!-- üóëÔ∏è Bot√≥n de borrado masivo (se ha movido al Navbar) -->
      </div>
    </div>

    <!-- üîπ Filtros (ocultos en modo selecci√≥n para limpiar UI) -->
    <div
      class="gallery-filters"
      aria-label="Filtrar fotos"
      [class.can-scroll]="shouldEnableFilterScroll"
      *ngIf="!isSelectionMode"
    >
      <!-- Favoritos -->
      <button
        type="button"
        class="filter-chip"
        [class.is-active]="activeFilter === 'favorites'"
        (click)="applyFilter('favorites')"
      >
        <span class="filter-icon">‚ù§Ô∏è</span>
        <span class="filter-label">Favoritos</span>
      </button>

      <!-- Todos -->
      <button
        type="button"
        class="filter-chip"
        [class.is-active]="activeFilter === 'all'"
        (click)="applyFilter('all')"
      >
        Todos
      </button>

      <!-- √Ålbumes -->
      @for (album of albums; track album.id) {
      <button
        type="button"
        class="filter-chip"
        [class.is-active]="isAlbumActive(album.id)"
        (click)="applyAlbumFilter(album.id)"
      >
        <span class="filter-label">{{ album.name }}</span>
      </button>
      }
    </div>
  </header>

  <!-- üïò Timeline Sidebar (Google Photos Style) -->
  @if (timelineData.length > 0 && showTimeline && !isSelectionMode && !isSkeletonVisible) {
  <aside class="timeline-sidebar">
    <div class="timeline-track">
      @for (yearData of timelineData; track yearData.year) {
      <div class="timeline-group">
        <!-- üîπ A√±o -->
        <div class="timeline-year">
          <span class="year-label">{{ yearData.year }}</span>
          <!-- Meses del a√±o -->
           @for (month of yearData.months; track month.anchorId) {
             <div class="timeline-month" 
                  (click)="scrollToAnchor(month.anchorId)" 
                  [title]="month.label + ' ' + yearData.year">
               <span class="month-dot"></span>
               <span class="month-label">{{ month.label }}</span>
             </div>
           }
        </div>
      </div>
      }
    </div>
  </aside>
  }

  <!-- üî∏ Estado: Cargando -->
  @if (isSkeletonVisible && !loadError) {
  <div class="gallery-skeleton" aria-hidden="true">
    @for (placeholder of skeletonPlaceholders; track placeholder) {
    <div class="skeleton-card"></div>
    }
    <p class="skeleton-message">Cargando recuerdos‚Ä¶</p>
  </div>
  }

  <!-- üî∏ Estado: Error -->
  @if (loadError) {
  <div class="gallery-error" role="alert">
    <p>{{ loadError }}</p>
    <button type="button" class="btn secondary" (click)="retryLoading()">Reintentar</button>
  </div>
  } @else {
  <!-- üî∏ Estado: Sin resultados -->
  @if (photos.length === 0) {
  <div class="gallery-empty">
    @if (activeFilter === 'favorites') {
      <p>A√∫n no tienes fotos favoritas. ¬°Marca algunas con el coraz√≥n! ‚ù§Ô∏è</p>
    } @else if (isAlbumSelectedWithoutPhotos()) {
      <p>No encontr√© recuerdos en este √°lbum. Prueba con otra opci√≥n preciosa üíñ</p>
      <button type="button" class="btn" (click)="applyFilter('all')">
        Agregar Fotos
      </button>
    } @else {
      <p>No encontr√© recuerdos para ese filtro. Prueba con otra opci√≥n preciosa üíñ</p>
    }
  </div>
  } @else {
  <!-- üîπ Grid de fotos -->
  <div class="gallery-grid" [class.is-loading]="isSkeletonVisible">
    @for (photo of photos; track photo.id) {
    <div class="gallery-item" [id]="'photo-' + photo.id" [class.is-loaded]="hasPhotoLoaded(photo.id)">
      <app-photo-card
        [photo]="photo"
        [isSelectionMode]="isSelectionMode"
        [isSelected]="selectedPhotoIds.has(photo.id)"
        (toggleSelection)="onPhotoSelect($event)"
        (openPreview)="openPreview($event)"
        (imageLoaded)="onPhotoLoaded($event)"
      ></app-photo-card>
    </div>
    }
  </div>
  } }

  <!-- üå∏ Nueva Vista Previa Simple -->
  @if (selectedPhoto) {
    <app-photo-preview
      [photo]="selectedPhoto"
      [hasNext]="hasNextPhoto"
      [hasPrev]="hasPreviousPhoto"
      (close)="closePreview()"
      (next)="showNextPhoto()"
      (prev)="showPreviousPhoto()"
      (delete)="onRequestPhotoDelete(selectedPhoto.id)"
    ></app-photo-preview>
  }

  <!-- üíñ Loader global (overlay fijo) -->
  <app-love-loader
    class="gallery-loader-overlay"
    [visible]="isLoaderVisible"
    [message]="loaderMessage"
    [gifSrc]="'/assets/love-loader.gif'"
  ></app-love-loader>
</section>

@if (showAlbumCreator) {
<app-album-creator
  [initialAlbum]="albumBeingEdited"
  (close)="closeAlbumEditor()"
  (create)="onAlbumCreate($event)"
  (update)="onAlbumUpdate($event)"
  (remove)="onAlbumRemove($event)"
></app-album-creator>
}

<app-confirm-dialog
  [visible]="confirmDeleteVisible"
  title="¬øEliminar √°lbum?"
  message="Esta acci√≥n eliminar√° el √°lbum y no podr√°s recuperarlo."
  confirmText="S√≠, eliminar"
  cancelText="Cancelar"
  (confirm)="confirmAlbumRemoval()"
  (cancel)="cancelAlbumRemoval()"
></app-confirm-dialog>

@if (showSelectAlbumModal) {
<app-select-album
  [photoId]="photoIdForAlbum"
  [photoLabel]="photoLabelForAlbum"
  [isBusy]="isAddToAlbumLoading"
  (close)="cancelAlbumSelection()"
  (confirm)="addPhotoToSelectedAlbums($event)"
  (requestCreateAlbum)="switchToCreateAlbum()"
></app-select-album>
}

<app-confirm-dialog
  [visible]="confirmPhotoDeleteVisible"
  title="¬øEliminar este recuerdo?"
  message="Si eliminas esta foto, se borrar√° para siempre de tus recuerdos."
  confirmText="S√≠, eliminar"
  cancelText="Cancelar"
  (confirm)="confirmPhotoRemoval()"
  (cancel)="cancelPhotoRemoval()"
></app-confirm-dialog>

<app-confirm-dialog
  [visible]="confirmRemoveFromAlbumVisible"
  [title]="'Quitar de ' + (albumNameForRemoval || 'este √°lbum') + '?'"
  [message]="'La foto dejar√° de aparecer en este √°lbum, pero seguir√° existiendo en tu galer√≠a.'"
  confirmText="S√≠, quitar"
  cancelText="Cancelar"
  (confirm)="confirmRemoveFromAlbum()"
  (cancel)="cancelRemoveFromAlbum()"
></app-confirm-dialog>

<app-confirm-dialog
  [visible]="confirmBatchDeleteVisible"
  title="¬øBorrar recuerdos seleccionados?"
  [message]="'Est√°s a punto de eliminar ' + selectedPhotoIds.size + ' recuerdos para siempre.'"
  confirmText="S√≠, borrar todo"
  cancelText="Cancelar"
  (confirm)="executeBatchDelete()"
  (cancel)="cancelBatchDelete()"
></app-confirm-dialog>
