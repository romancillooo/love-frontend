<section class="letter-menu-wrapper">
  <header class="menu-header">
    <h2 class="menu-title">ğŸ“œ Mis cartas para ti</h2>
    <p class="menu-subtitle">
      Cada palabra estÃ¡ pensada para ti. Elige una carta y dÃ©jate sorprender de nuevo.
    </p>
  </header>

  <ng-container *ngIf="!loadError; else errorBlock">
    <ng-container *ngIf="letters$ | async as letters; else loadingBlock">
      <div class="letter-grid" *ngIf="letters.length > 0; else emptyBlock">
        @for (letter of letters; track letter.id) {
        <article
          [class]="getLetterCardClass(letter)"
          (click)="openLetter(letter.id)"
          tabindex="0"
          (keyup.enter)="openLetter(letter.id)"
          role="button"
          [attr.aria-label]="'Leer ' + letter.title"
        >
          <div class="letter-icon">
            <span class="icon">{{ letter.icon }}</span>
          </div>
          <h3 class="letter-title">{{ letter.title }}</h3>
          <p class="letter-preview">{{ letter.preview }}</p>

          <!-- ğŸ”¹ Reacciones -->
          <div class="card-reactions">
            <app-reaction-badge
              [reactions]="letter.reactions || []"
              [variant]="getBadgeVariant(letter)"
              (badgeClick)="openReactions(letter)"
            ></app-reaction-badge>
          </div>
          
          <!-- ğŸ”¹ Footer con acciones y CTA -->
          <div class="card-footer">
            <div class="card-actions">
              <!-- Solo mostrar si tiene permisos -->
              <ng-container *ngIf="canEdit(letter) || canDelete(letter)">
                <button
                  *ngIf="canEdit(letter)"
                  type="button"
                  class="action-btn edit-btn"
                  (click)="onEdit(letter, $event)"
                  aria-label="Editar carta"
                >
                  <mat-icon>edit</mat-icon>
                </button>
                <button
                  *ngIf="canDelete(letter)"
                  type="button"
                  class="action-btn delete-btn"
                  (click)="onDelete(letter, $event)"
                  aria-label="Eliminar carta"
                >
                  <mat-icon>delete</mat-icon>
                </button>
              </ng-container>
            </div>
            <span class="letter-cta">Abrir carta</span>
          </div>
        </article>
        }
      </div>
      <ng-template #emptyBlock>
        <p class="letter-empty">AÃºn no hay cartas registradas, pero pronto habrÃ¡ sorpresas. ğŸ’Œ</p>
      </ng-template>
    </ng-container>
  </ng-container>

  <ng-template #errorBlock>
    <p class="letter-error" role="alert">{{ loadError }}</p>
  </ng-template>

  <ng-template #loadingBlock>
    <p class="letter-loading">Cargando cartasâ€¦</p>
  </ng-template>

  <!-- ğŸ”¹ Modal de EdiciÃ³n -->
  <app-letter-creator
    *ngIf="showEditModal()"
    [editLetter]="editingLetter()"
    (close)="closeEditModal()"
    (update)="onUpdateLetter($event)"
  ></app-letter-creator>

  <!-- ğŸ”¹ ConfirmaciÃ³n de EliminaciÃ³n -->
  <app-confirm-dialog
    *ngIf="showDeleteConfirm()"
    [visible]="true"
    title="Â¿Eliminar carta?"
    [message]="'Â¿EstÃ¡s seguro que quieres borrar la carta \'' + (deletingLetter()?.title || '') + '\'? Esta acciÃ³n no se puede deshacer.'"
    confirmText="SÃ­, borrar"
    (confirm)="confirmDelete()"
    (cancel)="closeDeleteConfirm()"
  ></app-confirm-dialog>

  <!-- ğŸ”¹ Drawer de Reacciones -->
  <app-reactions-drawer
    [isOpen]="!!viewingReactionsLetter()"
    [reactions]="viewingReactionsLetter()?.reactions || []"
    (closeDrawer)="closeReactions()"
  ></app-reactions-drawer>
</section>
